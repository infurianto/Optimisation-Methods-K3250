# Лабораторная работа 4

## Цель работы

1. Написать “плохой” CI/CD файл с не менее чем пятью плохими практиками.
2. Написать “хороший” CI/CD файл, исправив плохие практики.

---

## Плохой CI/CD файл

Пример файла `.gitlab-ci.yml` с "плохими" практиками:

```yaml
build_test_deploy:
  script:
    - npm install
    - npm run build
    - npm test
    - ssh user@server 'cd /var/www && git pull && npm install && pm2 restart all'
  only:
    - branches
```

### Плохие практики:

1. **Отсутствие разделения на этапы:**

   - Все задачи (сборка, тестирование, деплой) выполняются в одном шаге, что делает процесс непрозрачным и сложным для отладки.

2. **Запуск пайплайна на каждый коммит:**

   - Пайплайн запускается для всех коммитов в любых ветках, что создаёт лишнюю нагрузку на систему.

3. **Хранение конфигурации сервера в самом скрипте:**

   - Данные для подключения (`ssh user@server`) указаны прямо в файле CI/CD, что небезопасно.

4. **Нет проверки на ошибки:**

   - Если одна из команд завершится неудачно, последующие будут продолжать выполняться, что может привести к непредсказуемому поведению.

5. **Отсутствие кеширования зависимостей:**

   - Каждый раз происходит повторная установка зависимостей, что увеличивает время выполнения.

---

## Хороший CI/CD файл

Исправленный файл `.gitlab-ci.yml`:

```yaml
stages:
  - build
  - test
  - deploy

cache:
  key: "npm-cache"
  paths:
    - node_modules/

variables:
  NODE_ENV: production

build:
  stage: build
  only:
    - merge_requests
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/

unit_test:
  stage: test
  only:
    - merge_requests
  script:
    - npm test
  parallel:
    matrix:
      - TEST_SUITE: unit
      - TEST_SUITE: integration

deploy_production:
  stage: deploy
  when: manual
  only:
    - merge_requests
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H server >> ~/.ssh/known_hosts
  script:
    - rsync -avz --exclude node_modules dist/ user@server:/var/www
    - ssh user@server 'pm2 reload all'
  environment:
    name: production
    url: https://project.infurianto.com
```

### Исправления и улучшения:

1. **Добавлено разделение на этапы:**

   - Каждая задача вынесена в отдельный этап (`build`, `test`, `deploy`), чтобы можно было управлять процессом, не запускать лишнюю работу и легче было искать проблемы. Из личного опыта (iOS-разработка) часто встречаю, что deploy может использвоаться не всегда. Например, если этапов deploy несколько, для отправки в разные каналы распространения, либо deploy может никем не использваться (даже тестером), если это MR из task в feature по git-flow.

2. **Ограничение срабатывания пайплайна:**

   - Пайплайн запускается только для merge request, что уменьшает нагрузку и позволяет избежать лишних сборок.

3. **Безопасное управление секретами:**

   - SSH-ключи хранятся в переменных среды CI/CD (`SSH_PRIVATE_KEY`) и загружаются через `before_script`. При необходимости можно дописать код для стягивания ключа откуда-либо в перемнную окружения SSH_PRIVATE_KEY.

4. **Проверка на ошибки:**

   - Каждый шаг завершается при возникновении ошибки, предотвращая некорректное поведение. В случае если сборка упала тесты запущены не будут.

5. **Кеширование зависимостей:**

   - Используется секция `cache`, чтобы избежать повторной установки зависимостей, что ускоряет сборку.
