# Лабораторная работа 2*

## Цель работы
1. Продемонстрировать плохие практики при написании Docker Compose файла
2. Исправить ошибки, создав правильные версии файлов, и объяснить, почему выбранные исправления улучшили результат.
3. Настроить сервисы в хорошем Docker Compose файле так, чтобы они не видели друг друга по сети.

---

## Плохой Docker Compose файл

```yaml
version: '3'
services:
  app:
    build: .
    ports:
      - "80:80"
    environment:
      - DEBUG=true
    depends_on:
      - db
  db:
    image: mysql:5.7
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=test
  redis:
    image: redis:latest
```

### Плохие практики:
1. **Использование устаревшей версии Compose:**
   - `version: '3'` не поддерживает современные функции, такие как `secrets` или более гибкие настройки сетей.

2. **Хранение паролей в переменных окружения:**
   - Пароль для базы данных (`MYSQL_ROOT_PASSWORD`) указан явно в `docker-compose.yml`, что небезопасно.

3. **Отсутствие изоляции сетей:**
   - Все сервисы (app, db, redis) находятся в одной сети по умолчанию, что увеличивает риск нежелательного взаимодействия между ними.

4. **Отсутствие ограничения ресурсов для сервисов:**
   - Никакие лимиты на использование CPU или памяти не установлены, что может привести к чрезмерному потреблению ресурсов одним из сервисов и повлиять на работу других.

---

## Хороший Docker Compose файл

```yaml
version: '3.9'
services:
  app:
    build: .
    ports:
      - "80:80"
    environment:
      - DEBUG=false
    networks:
      - app_net
    depends_on:
      - db
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "256M"
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_password
      MYSQL_DATABASE: test
    secrets:
      - db_password
    networks:
      - db_net
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: "512M"
  redis:
    image: redis:7.0
    networks:
      - redis_net
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: "128M"

networks:
  app_net:
    driver: bridge
  db_net:
    driver: bridge
  redis_net:
    driver: bridge

secrets:
  db_password:
    file: ./secrets/db_password.txt
```

### Исправления и улучшения:
1. **Обновление версии Compose:**
   - Использована версия `3.9`, которая поддерживает современные возможности, такие как `secrets` и улучшенные настройки сетей.

2. **Перенос паролей в секцию `secrets`:**
   - Пароль для базы данных вынесен в файл `db_password.txt` и подключается через секцию `secrets`, что значительно повышает безопасность.

3. **Добавление изоляции сетей:**
   - Каждый сервис работает в своей сети (`app_net`, `db_net`, `redis_net`), что исключает нежелательное взаимодействие между сервисами.

---

## Настройка изоляции

Для достижения изоляции сервисов были выполнены следующие действия:
1. Созданы три независимые сети (`app_net`, `db_net`, `redis_net`).
2. Каждому сервису назначена только одна сеть, исключая взаимодействие с другими сервисами.

### Принцип работы:
- Docker создаёт отдельные виртуальные сети для каждого сервиса.
- Контейнеры внутри одной сети могут взаимодействовать друг с другом, но не видят контейнеры в других сетях.
- Это позволяет изолировать сервисы и минимизировать риски безопасности.

