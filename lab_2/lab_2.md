# Лабораторная работа 2

## Цель работы
1. Продемонстрировать плохие практики при написании Dockerfile
2. Исправить ошибки, создав правильные версии файлов, и объяснить, почему выбранные исправления улучшили результат.
3. Рассмотреть две плохие практики при работе с контейнерами.

---

## Плохой Dockerfile

```dockerfile
# Используется образ без указания версии
FROM php

# Установка зависимостей без удаления временных файлов
RUN apt-get update && apt-get install -y curl git zip

# Копирование всех файлов, включая лишние
COPY . /var/www/html

# Работа от имени root (по умолчанию)
CMD ["php", "-S", "0.0.0.0:8000", "-t", "/var/www/html"]
```
Здесь допущены следующие ошибки:
1. **Неуказанная версия базового образа:**
   - При использовании `FROM` php Docker возьмёт последнюю доступную версию образа. Это может привести к неожиданным изменениям в поведении приложения при обновлении образа.
2. **Не удаляются временные файлы при установке зависимостей:**
   - После установки пакетов остаются временные файлы, такие как кеши apt, которые занимают место в образе.
3. **Копирование всех файлов:**
   - Включение ненужных файлов (например, `.git`, временных файлов) в контейнер увеличивает размер образа.
   - В образ могут попасть файлы, содержащие секреты, такие как .env или файлы API-ключей.
4. **Работа от имени root:**
   - Контейнеры, работающие от имени root, могут использоваться для атаки на хост-систему через уязвимости.

---

## Хороший Dockerfile

```dockerfile
# Использование конкретного базового образа
FROM php:8.1

# Установка зависимостей с очисткой временных файлов
RUN apt-get update && apt-get install -y curl git zip && rm -rf /var/lib/apt/lists/*

# Копирование только необходимых файлов
COPY src /var/www/html

# Создание безопасного пользователя
RUN useradd -m appuser
USER appuser

# Указание рабочей директории
WORKDIR /var/www/html

CMD ["php", "-S", "0.0.0.0:8000", "-t", "/var/www/html"]
```

Исправления и улучшения:
1. **Указание версии базового образа:**
   - Гарантирует стабильность образа и предотвращает неожиданные изменения при обновлении.
2. **Очистка временных файлов после установки:**
   - Уменьшает размер конечного образа.
3. **Копирование только необходимых файлов:**
   - Устраняет включение лишних данных, таких как .git или временные файлы.
4. **Работа от имени безопасного пользователя:**
   - Повышает безопасность и снижает риск эксплуатации уязвимостей.

---

## Плохие практики при работе с контейнерами

1. **Запуск контейнеров с привилегиями:**
   - Почему плохо: Привилегированные контейнеры могут получить доступ к хостовой системе.
   - Как избежать: Использовать флаг `--user` для запуска контейнера от имени безопасного пользователя.
   - Пример: `docker run --user 1000:1000 my-container`. Здесь 1000:1000 — UID и GID пользователя, который будет использоваться внутри контейнера.

2. **Отсутствие ограничения ресурсов:**
   - Почему плохо: Контейнер может занять все доступные ресурсы, влияя на работу других приложений.
   - Как избежать: Установить лимиты на CPU и память с помощью флагов `--memory` и `--cpus`.
   - Пример: `docker run --memory=512m --cpus=1 my-container`. В данном примере контейнер ограничен 512 МБ памяти и 1 ядром процессора.